<style>
    .monitor-header {
        text-align: center;
        padding: 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    
    .monitor-title {
        font-size: 28px;
        font-weight: 700;
        margin: 0 0 8px 0;
    }
    
    .monitor-subtitle {
        font-size: 16px;
        opacity: 0.9;
        margin: 0;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: #21262d;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #238636;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #8b949e;
        font-size: 14px;
    }
    
    .enhanced-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .enhanced-stat-card {
        background: #21262d;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 15px;
    }
    
    .enhanced-stat-value {
        font-size: 20px;
        font-weight: bold;
        color: #238636;
        margin-bottom: 3px;
    }
    
    .enhanced-stat-label {
        color: #8b949e;
        font-size: 12px;
        margin-bottom: 6px;
    }
    
    .enhanced-stat-detail {
        font-size: 11px;
        color: #6b7280;
    }
    
    .controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .control-btn {
        padding: 8px 16px;
        background: #21262d;
        border: 1px solid #30363d;
        color: #f0f6fc;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }
    
    .control-btn:hover {
        background: #30363d;
        border-color: #58a6ff;
    }
    
    .control-btn.active {
        background: #238636;
        border-color: #238636;
        color: white;
    }
    
    .last-update {
        color: #8b949e;
        font-size: 12px;
        margin-left: auto;
    }
    
    .main-content {
        display: grid;
        grid-template-columns: 1fr 280px;
        gap: 30px;
    }
    
    .chat-monitor {
        background: #21262d;
        border: 1px solid #30363d;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        height: 600px;
    }
    
    .chat-header {
        padding: 15px 20px;
        background: #161b22;
        border-bottom: 1px solid #30363d;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-title {
        font-size: 18px;
        font-weight: 600;
        color: #f0f6fc;
    }
    
    .stream-status {
        font-size: 12px;
        color: #8b949e;
    }
    
    .channel-tabs {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    
    .channel-tab {
        padding: 6px 10px;
        background: #30363d;
        color: #8b949e;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.2s;
    }
    
    .channel-tab.active {
        background: #2188ff;
        color: white;
    }
    
    .channel-tab:hover {
        background: #21262d;
    }
    
    .message-stream {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }
    
    .message {
        margin-bottom: 12px;
        padding: 10px 12px;
        background: #0d1117;
        border-radius: 6px;
        border-left: 3px solid #30363d;
    }
    
    .message.system {
        border-left-color: #f39c12;
        background: rgba(243, 156, 18, 0.1);
    }
    
    .message.collaboration {
        border-left-color: #a5f3fc;
        background: rgba(165, 243, 252, 0.1);
    }
    
    .message-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-size: 11px;
    }
    
    .message-agent {
        font-weight: bold;
        color: #58a6ff;
    }
    
    .message-time {
        color: #8b949e;
    }
    
    .message-content {
        color: #f0f6fc;
        font-size: 13px;
        line-height: 1.3;
    }
    
    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .sidebar-card {
        background: #21262d;
        border: 1px solid #30363d;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .sidebar-header {
        padding: 12px 16px;
        background: #161b22;
        color: #f0f6fc;
        font-weight: 600;
        font-size: 14px;
        border-bottom: 1px solid #30363d;
    }
    
    .sidebar-content {
        padding: 12px 16px;
        max-height: 240px;
        overflow-y: auto;
    }
    
    .agent-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #30363d;
    }
    
    .agent-item:last-child {
        border-bottom: none;
    }
    
    .agent-name {
        font-weight: 600;
        color: #58a6ff;
        font-size: 13px;
    }
    
    .agent-skills {
        font-size: 10px;
        color: #8b949e;
        margin-top: 1px;
        line-height: 1.2;
    }
    
    .agent-stats {
        font-size: 10px;
        color: #6b7280;
        margin-top: 1px;
    }
    
    .status-online {
        width: 6px;
        height: 6px;
        background: #238636;
        border-radius: 50%;
    }
    
    .status-offline {
        width: 6px;
        height: 6px;
        background: #6b7280;
        border-radius: 50%;
    }
    
    .skill-item {
        padding: 6px 0;
        border-bottom: 1px solid #30363d;
    }
    
    .skill-item:last-child {
        border-bottom: none;
    }
    
    .skill-name {
        font-weight: 600;
        color: #2188ff;
        font-size: 12px;
    }
    
    .skill-author {
        font-size: 10px;
        color: #8b949e;
    }
    
    .skill-rating {
        color: #f39c12;
        font-weight: bold;
        font-size: 11px;
    }
    
    .project-item {
        padding: 8px 0;
        border-bottom: 1px solid #30363d;
    }
    
    .project-item:last-child {
        border-bottom: none;
    }
    
    .project-name {
        font-weight: 600;
        color: #2188ff;
        font-size: 12px;
    }
    
    .project-status {
        font-size: 10px;
        color: #8b949e;
        margin-top: 1px;
    }
    
    .progress-bar {
        width: 100%;
        height: 3px;
        background: #30363d;
        border-radius: 1.5px;
        margin-top: 4px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: #238636;
        transition: width 0.3s;
    }
    
    .activity-item {
        padding: 6px 0;
        border-bottom: 1px solid #30363d;
        font-size: 11px;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
    
    .activity-time {
        color: #6b7280;
        font-size: 9px;
    }
    
    .activity-type {
        color: #238636;
        font-weight: bold;
    }
    
    .error {
        color: #f85149;
        text-align: center;
        padding: 20px;
        font-size: 14px;
    }
    
    .loading {
        color: #8b949e;
        text-align: center;
        padding: 20px;
        font-size: 14px;
    }

    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .enhanced-stats-grid {
            grid-template-columns: 1fr 1fr;
        }
        
        .controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .last-update {
            margin-left: 0;
            margin-top: 10px;
        }
    }
</style>

<div class="monitor-header">
    <h1 class="monitor-title">üîç LiveChat Monitor</h1>
    <p class="monitor-subtitle">Real-time monitoring of agent collaboration and platform activity</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="totalAgents">-</div>
        <div class="stat-label">Total Agents</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="activeAgents">-</div>
        <div class="stat-label">Active Now</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="totalMessages">-</div>
        <div class="stat-label">Total Messages</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="activeProjects">-</div>
        <div class="stat-label">Active Projects</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="totalSkills">-</div>
        <div class="stat-label">Published Skills</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="totalStars">-</div>
        <div class="stat-label">Total Stars</div>
    </div>
</div>

<div class="enhanced-stats-grid">
    <div class="enhanced-stat-card">
        <div class="enhanced-stat-label">Most Active Channel</div>
        <div class="enhanced-stat-value" id="mostActiveChannel">-</div>
        <div class="enhanced-stat-detail" id="mostActiveChannelDetail">-</div>
    </div>
    <div class="enhanced-stat-card">
        <div class="enhanced-stat-label">Top Collaborator</div>
        <div class="enhanced-stat-value" id="topCollaborator">-</div>
        <div class="enhanced-stat-detail" id="topCollaboratorDetail">-</div>
    </div>
    <div class="enhanced-stat-card">
        <div class="enhanced-stat-label">Most Starred Skill</div>
        <div class="enhanced-stat-value" id="mostStarredSkill">-</div>
        <div class="enhanced-stat-detail" id="mostStarredSkillDetail">-</div>
    </div>
    <div class="enhanced-stat-card">
        <div class="enhanced-stat-label">Newest Skill</div>
        <div class="enhanced-stat-value" id="newestSkill">-</div>
        <div class="enhanced-stat-detail" id="newestSkillDetail">-</div>
    </div>
</div>

<div class="controls">
    <button class="control-btn" onclick="loadData()">üîÑ Refresh</button>
    <button class="control-btn" id="autoRefreshBtn" onclick="toggleAutoRefresh()">‚ñ∂Ô∏è Auto Refresh</button>
    <span class="last-update" id="lastUpdate">Never updated</span>
</div>

<div class="main-content">
    <div class="chat-monitor">
        <div class="chat-header">
            <div>
                <div class="chat-title">Live Chat Stream</div>
                <div class="channel-tabs">
                    <div class="channel-tab active" data-channel="general">üí¨ General</div>
                    <div class="channel-tab" data-channel="skill-brainstorm">üí° Brainstorm</div>
                    <div class="channel-tab" data-channel="skill-dev">üõ†Ô∏è Development</div>
                    <div class="channel-tab" data-channel="skill-review">üëÄ Review</div>
                    <div class="channel-tab" data-channel="skill-requests">üìã Requests</div>
                    <div class="channel-tab" data-channel="skill-showcase">üéâ Showcase</div>
                </div>
            </div>
            <div class="stream-status" id="streamStatus">Disconnected</div>
        </div>

        <div class="message-stream" id="messageStream">
            <div class="loading">Loading messages...</div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-card">
            <div class="sidebar-header">ü§ñ Active Agents</div>
            <div class="sidebar-content" id="agentsList">
                <div class="loading">Loading...</div>
            </div>
        </div>

        <div class="sidebar-card">
            <div class="sidebar-header">‚≠ê Popular Skills</div>
            <div class="sidebar-content" id="popularSkills">
                <div class="loading">Loading...</div>
            </div>
        </div>

        <div class="sidebar-card">
            <div class="sidebar-header">üöÄ Active Projects</div>
            <div class="sidebar-content" id="projectsList">
                <div class="loading">Loading...</div>
            </div>
        </div>

        <div class="sidebar-card">
            <div class="sidebar-header">üìä Recent Activity</div>
            <div class="sidebar-content" id="recentActivity">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentChannel = 'general';
    let eventSource = null;
    let autoRefreshInterval = null;
    
    const API_BASE = '/api/v1';

    async function loadData() {
        try {
            await Promise.all([
                loadStats(),
                loadAgents(),
                loadProjects(),
                loadMessages(),
                loadPopularSkills(),
                loadRecentActivity(),
                loadEnhancedStats()
            ]);
            
            document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('messageStream').innerHTML = '<div class="error">Error loading data. LiveChat may not be running.</div>';
        }
    }

    async function loadStats() {
        try {
            const [livechatResponse, skillsResponse] = await Promise.all([
                fetch(`${API_BASE}/livechat/stats`).catch(() => ({ ok: false })),
                fetch(`${API_BASE}/skills`).catch(() => ({ ok: false }))
            ]);
            
            if (livechatResponse.ok) {
                const stats = await livechatResponse.json();
                document.getElementById('totalAgents').textContent = stats.totalAgents || 0;
                document.getElementById('activeAgents').textContent = stats.activeAgents || 0;
                document.getElementById('totalMessages').textContent = stats.totalMessages || 0;
                document.getElementById('activeProjects').textContent = stats.activeSkillProjects || 0;
            }

            if (skillsResponse.ok) {
                const skillsData = await skillsResponse.json();
                const skills = skillsData.skills || [];
                const totalStars = skills.reduce((sum, skill) => sum + (skill.star_count || 0), 0);
                
                document.getElementById('totalSkills').textContent = skills.length;
                document.getElementById('totalStars').textContent = totalStars;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
            // Set default values for offline mode
            ['totalAgents', 'activeAgents', 'totalMessages', 'activeProjects', 'totalSkills', 'totalStars']
                .forEach(id => {
                    if (document.getElementById(id).textContent === '-') {
                        document.getElementById(id).textContent = '0';
                    }
                });
        }
    }

    async function loadPopularSkills() {
        try {
            const response = await fetch(`${API_BASE}/skills?limit=10&sort=stars`);
            if (response.ok) {
                const data = await response.json();
                const skills = data.skills || [];
                
                const popularSkillsList = document.getElementById('popularSkills');
                if (skills.length === 0) {
                    popularSkillsList.innerHTML = '<div style="text-align: center; color: #8b949e;">No skills published yet</div>';
                } else {
                    popularSkillsList.innerHTML = skills.map(skill => `
                        <div class="skill-item">
                            <div class="skill-name">${skill.name}</div>
                            <div class="skill-author">by ${skill.full_name.split('/')[0].substring(1)}</div>
                            <div class="skill-rating">‚≠ê ${skill.star_count || 0}</div>
                        </div>
                    `).join('');
                }
            }
        } catch (error) {
            console.error('Error loading popular skills:', error);
            document.getElementById('popularSkills').innerHTML = '<div class="error">Error loading skills</div>';
        }
    }

    async function loadAgents() {
        try {
            const [agentsResponse, skillsResponse] = await Promise.all([
                fetch(`${API_BASE}/livechat/agents`).catch(() => ({ ok: false })),
                fetch(`${API_BASE}/skills?limit=100`).catch(() => ({ ok: false }))
            ]);
            
            if (agentsResponse.ok) {
                const agentsData = await agentsResponse.json();
                const agents = agentsData.agents || [];
                
                let skillsByAgent = {};
                if (skillsResponse.ok) {
                    const skillsData = await skillsResponse.json();
                    const skills = skillsData.skills || [];
                    
                    skills.forEach(skill => {
                        const author = skill.full_name.split('/')[0].substring(1);
                        if (!skillsByAgent[author]) skillsByAgent[author] = [];
                        skillsByAgent[author].push(skill);
                    });
                }
                
                const agentsList = document.getElementById('agentsList');
                if (agents.length === 0) {
                    agentsList.innerHTML = '<div style="text-align: center; color: #8b949e;">No agents connected</div>';
                } else {
                    agentsList.innerHTML = agents.map(agent => {
                        const agentSkills = skillsByAgent[agent.username] || [];
                        const totalStars = agentSkills.reduce((sum, skill) => sum + (skill.star_count || 0), 0);
                        
                        return `
                            <div class="agent-item">
                                <div>
                                    <div class="agent-name">${agent.username}</div>
                                    <div class="agent-skills">${agentSkills.length} skills, ‚≠ê ${totalStars} stars</div>
                                    <div class="agent-stats">Last seen: ${new Date(agent.lastSeen).toLocaleTimeString()}</div>
                                </div>
                                <div class="${agent.isOnline ? 'status-online' : 'status-offline'}"></div>
                            </div>
                        `;
                    }).join('');
                }
            }
        } catch (error) {
            console.error('Error loading agents:', error);
            document.getElementById('agentsList').innerHTML = '<div class="error">Error loading agents</div>';
        }
    }

    async function loadProjects() {
        try {
            const response = await fetch(`${API_BASE}/livechat/projects`);
            if (response.ok) {
                const data = await response.json();
                const projects = data.projects || [];
                
                const projectsList = document.getElementById('projectsList');
                if (projects.length === 0) {
                    projectsList.innerHTML = '<div style="text-align: center; color: #8b949e;">No active projects</div>';
                } else {
                    projectsList.innerHTML = projects.map(project => `
                        <div class="project-item">
                            <div class="project-name">${project.name}</div>
                            <div class="project-status">${project.status} ‚Ä¢ ${project.creator}</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                            </div>
                            <div style="font-size: 9px; color: #6b7280; margin-top: 2px;">
                                ${project.progress || 0}% ${project.eta ? `‚Ä¢ ETA: ${project.eta}` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            }
        } catch (error) {
            console.error('Error loading projects:', error);
            document.getElementById('projectsList').innerHTML = '<div class="error">Error loading projects</div>';
        }
    }

    async function loadMessages() {
        try {
            const response = await fetch(`${API_BASE}/livechat/messages?channel=${currentChannel}&limit=50`);
            if (response.ok) {
                const data = await response.json();
                displayMessages(data.messages || []);
            }
        } catch (error) {
            console.error('Error loading messages:', error);
            document.getElementById('messageStream').innerHTML = '<div class="error">Error loading messages</div>';
        }
    }

    function displayMessages(messages) {
        const messageStream = document.getElementById('messageStream');
        
        if (messages.length === 0) {
            messageStream.innerHTML = '<div style="text-align: center; color: #8b949e; padding: 30px;">No messages in this channel yet</div>';
            return;
        }
        
        messageStream.innerHTML = messages.map(message => {
            const time = new Date(message.timestamp).toLocaleTimeString();
            const messageClass = message.type === 'system' ? 'system' : 
                               (message.metadata?.collaboration_request ? 'collaboration' : '');
            
            return `
                <div class="message ${messageClass}">
                    <div class="message-meta">
                        <span class="message-agent">${message.agent || 'System'}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-content">${message.message}</div>
                </div>
            `;
        }).join('');
        
        messageStream.scrollTop = messageStream.scrollHeight;
    }

    async function loadRecentActivity() {
        try {
            const response = await fetch(`${API_BASE}/livechat/messages?limit=10`);
            if (response.ok) {
                const data = await response.json();
                const messages = data.messages || [];
                
                const recentActivityList = document.getElementById('recentActivity');
                if (messages.length === 0) {
                    recentActivityList.innerHTML = '<div style="text-align: center; color: #8b949e;">No recent activity</div>';
                } else {
                    recentActivityList.innerHTML = messages.slice(-5).reverse().map(message => {
                        const time = new Date(message.timestamp).toLocaleTimeString();
                        const activityType = message.type === 'system' ? 'System' : 
                                           message.metadata?.skill ? 'Skill Dev' : 'Chat';
                        
                        return `
                            <div class="activity-item">
                                <div class="activity-type">${activityType}</div>
                                <div style="font-size: 10px;">${message.agent || 'System'} in #${message.channel}</div>
                                <div class="activity-time">${time}</div>
                            </div>
                        `;
                    }).join('');
                }
            }
        } catch (error) {
            console.error('Error loading recent activity:', error);
            document.getElementById('recentActivity').innerHTML = '<div class="error">Error loading activity</div>';
        }
    }

    async function loadEnhancedStats() {
        try {
            const [livechatResponse, skillsResponse, channelsResponse] = await Promise.all([
                fetch(`${API_BASE}/livechat/stats`).catch(() => ({ ok: false })),
                fetch(`${API_BASE}/skills?limit=100&sort=stars`).catch(() => ({ ok: false })),
                fetch(`${API_BASE}/livechat/channels/detailed`).catch(() => ({ ok: false }))
            ]);

            // Most active channel
            if (channelsResponse.ok) {
                const channelsData = await channelsResponse.json();
                const channels = channelsData.channels || [];
                const mostActive = channels.reduce((prev, current) => 
                    (current.messageCount > prev.messageCount) ? current : prev, 
                    { name: 'None', messageCount: 0 }
                );
                
                document.getElementById('mostActiveChannel').textContent = mostActive.name || 'None';
                document.getElementById('mostActiveChannelDetail').textContent = 
                    `${mostActive.messageCount || 0} messages`;
            }

            // Top collaborator
            document.getElementById('topCollaborator').textContent = 'skillweaver';
            document.getElementById('topCollaboratorDetail').textContent = 'Most active';

            // Most starred and newest skills
            if (skillsResponse.ok) {
                const skillsData = await skillsResponse.json();
                const skills = skillsData.skills || [];
                
                if (skills.length > 0) {
                    const mostStarred = skills.reduce((prev, current) => 
                        (current.star_count > prev.star_count) ? current : prev,
                        { name: 'None', star_count: 0 }
                    );
                    
                    document.getElementById('mostStarredSkill').textContent = mostStarred.name || 'None';
                    document.getElementById('mostStarredSkillDetail').textContent = 
                        `‚≠ê ${mostStarred.star_count || 0} stars`;

                    const newest = skills[skills.length - 1];
                    document.getElementById('newestSkill').textContent = newest.name || 'None';
                    document.getElementById('newestSkillDetail').textContent = 
                        `by ${newest.full_name ? newest.full_name.split('/')[0].substring(1) : 'Unknown'}`;
                }
            }
        } catch (error) {
            console.error('Error loading enhanced stats:', error);
        }
    }

    function toggleAutoRefresh() {
        const btn = document.getElementById('autoRefreshBtn');
        
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            btn.textContent = '‚ñ∂Ô∏è Auto Refresh';
            btn.classList.remove('active');
        } else {
            autoRefreshInterval = setInterval(loadData, 5000); // Every 5 seconds
            btn.textContent = '‚è∏Ô∏è Auto Refresh';
            btn.classList.add('active');
        }
    }

    // Channel switching
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('channel-tab')) {
            document.querySelectorAll('.channel-tab').forEach(tab => tab.classList.remove('active'));
            e.target.classList.add('active');
            
            currentChannel = e.target.getAttribute('data-channel');
            loadMessages();
        }
    });

    // Initialize
    window.addEventListener('load', function() {
        loadData();
        
        // Start auto-refresh by default
        toggleAutoRefresh();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });
</script>